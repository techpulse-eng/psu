{"version":3,"sources":["components/pages/notLicensed.tsx","components/dashboard/components/DashboardTerminal.tsx"],"names":["NotLicensed","title","status","extra","icon","onClick","window","location","href","fitAddon","FitAddon","searchAddon","SearchAddon","webLinksAddon","WebLinksAddon","sendToTerminal","command","id","a","axios","method","url","data","response","DashboardTerminal","xtermRef","React","useRef","xtermCommandRef","licensed","useAppStore","useParams","useQuery","enabled","Feature","Dashboard","select","refetchOnMount","refetchOnWindowFocus","send","useMutation","cmd","onError","error","variables","context","message","mutateAsync","useEffect","termRefVar","current","terminal","writeln","write","attachCustomKeyEventHandler","arg","code","type","ctrlKey","selection","getSelection","navigator","clipboard","writeText","readText","then","text","onKey","key","toLocaleLowerCase","clear","i","length","parseInt","buffer","active","cursorX","substr","dispose","ref","addons","options","cols","cursorBlink"],"mappings":"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","file":"static/js/48.f1735a82.chunk.js","sourcesContent":["import React from \"react\";\r\nimport { Result, Button } from \"antd\";\r\nimport { CreditCardOutlined } from \"@ant-design/icons\";\r\n\r\nexport default function NotLicensed({ title }) {\r\n  return (\r\n    <Result\r\n      title={title}\r\n      status=\"warning\"\r\n      extra={\r\n        <Button\r\n          icon={<CreditCardOutlined />}\r\n          onClick={() => {\r\n            window.location.href =\r\n              \"https://ironmansoftware.com/powershell-universal?rel=product\";\r\n          }}\r\n        >\r\n          Buy License\r\n        </Button>\r\n      }\r\n    />\r\n  );\r\n}\r\n","import React, { useEffect } from \"react\";\r\nimport useAppStore from \"components/context/app/Hooks\";\r\nimport { Dashboard, Feature } from \"types\";\r\nimport NotLicensed from \"components/pages/notLicensed\";\r\nimport { useParams } from \"react-router-dom\";\r\nimport { useMutation, useQuery } from \"react-query3\";\r\nimport { WebLinksAddon } from \"xterm-addon-web-links\";\r\nimport { FitAddon } from \"xterm-addon-fit\";\r\nimport { SearchAddon } from \"xterm-addon-search\";\r\nimport axios, { AxiosError } from \"axios\";\r\nimport { message } from \"antd\";\r\nimport { XTerm } from \"xterm-for-react\";\r\n\r\n// const terminal = new Terminal();\r\nconst fitAddon = new FitAddon();\r\nconst searchAddon = new SearchAddon();\r\nconst webLinksAddon = new WebLinksAddon();\r\n\r\nasync function sendToTerminal(command: string, id: number) {\r\n  var response = await axios({\r\n    method: \"post\",\r\n    url: `/api/v1/dashboard/${id}/terminal`,\r\n    data: { command },\r\n  });\r\n  return response.data;\r\n}\r\n\r\nconst DashboardTerminal = () => {\r\n  const xtermRef = React.useRef<XTerm>(null);\r\n  const xtermCommandRef = React.useRef<string>(\"\");\r\n  const { licensed } = useAppStore();\r\n  const { id } = useParams();\r\n\r\n  const { data: status } = useQuery<any>(`/dashboard/${id}`, {\r\n    enabled: !!id && licensed(Feature.Dashboard),\r\n    select: (data: Dashboard) => {\r\n      return data?.status;\r\n    },\r\n    refetchOnMount: false,\r\n    refetchOnWindowFocus: false,\r\n  });\r\n\r\n  const { mutateAsync: send } = useMutation(\r\n    async ({ id, cmd }: { id: number; cmd: string }) =>\r\n      await sendToTerminal(cmd, id),\r\n    {\r\n      onError: (error: AxiosError, variables, context) => {\r\n        message.error(`Command faild; ${error?.message}`);\r\n      },\r\n    }\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (!licensed(Feature.Dashboard)) return;\r\n    let termRefVar = xtermRef.current;\r\n    if (status !== 1) {\r\n      xtermRef.current.terminal.writeln(\"Dashboard not running.\");\r\n    } else {\r\n      xtermRef.current.terminal.writeln(\r\n        \"Connected to the Universal Dashboard Admin Terminal\"\r\n      );\r\n      xtermRef.current.terminal.write(\"PS> \");\r\n      const terminal = xtermRef.current.terminal;\r\n\r\n      terminal.attachCustomKeyEventHandler((arg) => {\r\n        if (arg.code === \"Home\" && arg.type === \"keydown\") {\r\n          return false;\r\n        }\r\n\r\n        if (arg.ctrlKey && arg.code === \"KeyC\" && arg.type === \"keydown\") {\r\n          const selection = terminal.getSelection();\r\n          if (selection) {\r\n            navigator.clipboard.writeText(selection);\r\n            return false;\r\n          }\r\n        }\r\n\r\n        if (arg.ctrlKey && arg.code === \"KeyV\" && arg.type === \"keydown\") {\r\n          navigator.clipboard.readText()\r\n            .then(text => {\r\n              terminal.write(text);\r\n            })\r\n        };\r\n        return true;\r\n      });\r\n\r\n      xtermRef.current.terminal.onKey((key) => {\r\n        const terminal = xtermRef.current.terminal;\r\n\r\n        if (key.key === \"\\r\") {\r\n          if (xtermCommandRef.current.toLocaleLowerCase() === \"cls\" || xtermCommandRef.current.toLocaleLowerCase() === \"clear-host\") {\r\n            terminal.clear();\r\n            for (let i = 0; i < 4 + xtermCommandRef.current.length; i++) {\r\n              terminal.write('\\b \\b');\r\n            }\r\n\r\n            terminal.write(\"PS> \");\r\n            xtermCommandRef.current = \"\";\r\n            return;\r\n          }\r\n\r\n          send({ id: parseInt(id), cmd: xtermCommandRef.current }).then(\r\n            (response) => {\r\n              terminal.writeln(response);\r\n              terminal.write(\"PS> \");\r\n              xtermCommandRef.current = \"\";\r\n            }\r\n          );\r\n        }\r\n\r\n        // escape\r\n        if (key.key === \"\\x1B\") {\r\n          if (xtermCommandRef.current.length > 0) {\r\n            for (let i = 0; i < xtermCommandRef.current.length; i++) {\r\n              terminal.write('\\b \\b');\r\n            }\r\n            xtermCommandRef.current = \"\";\r\n          }\r\n          return;\r\n        }\r\n\r\n        //backspace\r\n        if (key.key === \"\\x7F\" && terminal.buffer.active.cursorX > 4) {\r\n          if (xtermCommandRef.current.length > 0) {\r\n            xtermCommandRef.current = xtermCommandRef.current.substr(0, xtermCommandRef.current.length - 1);\r\n          }\r\n          terminal.write('\\b \\b');\r\n          return;\r\n        }\r\n\r\n\r\n\r\n        xtermRef.current.terminal.write(key.key);\r\n        xtermCommandRef.current = xtermCommandRef.current + key.key;\r\n      });\r\n    }\r\n    return () => termRefVar.terminal.dispose();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [id, status]);\r\n\r\n  if (!licensed(Feature.Dashboard)) {\r\n    return (\r\n      <NotLicensed title=\"Console is only available for licensed instances.\" />\r\n    );\r\n  }\r\n\r\n  return (\r\n    <XTerm\r\n      ref={xtermRef}\r\n      addons={[searchAddon, fitAddon, webLinksAddon]}\r\n      options={{\r\n        cols: 80,\r\n        cursorBlink: true,\r\n      }}\r\n    />\r\n  );\r\n};\r\n\r\nexport default DashboardTerminal;\r\n"],"sourceRoot":""}